<!doctype html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Flywire SDK -->
<!--    <script src="https://artifacts.flywire.com/sdk/js/v0/sandbox.main.js"></script>-->
    <script th:src="@{${sdkUrl}}"></script>

    <script th:inline="javascript">
        // rawAccountBalance is injected as a JS variable
        let rawAccountBalance = [[${raw_account_balance}]];
        console.log("Raw balance:", rawAccountBalance);
    </script>

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.1.3/dist/css/bootstrap.min.css"
          integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">


    <title>Flywire Payment Gateway</title>
</head>
<body>

<div class="container">

    <!--Jumbotron-->
    <div class="jumbotron jumbotron-fluid bg-primary text-center">
        <div class="container">
            <div class="text-center">
                <img class="img-fluid" src="./images/flywire-logo-scaled.jpg" width="327" alt="flywire logo">
            </div>
            <h1 class="display-4 text-light">Institution Flywire Payment Gateway</h1>
        </div>
    </div>

    <div class="text-center">
        <img class="img-fluid" src="./images/model-university.png" width="327" alt="University logo">
    </div>
    <hr/>
    <div class="row justify-content-center">. . .</div>
    <hr/>
    <!-- Flywire payment widget will render here -->
    <div id="my-container-id" style="display: none; width: 100%; height: 800px; margin-top: 30px;"></div>

    <form id="paymentForm">
        <div class="form-row">
            <div class="form-group col-md-6">
                <label for="inputFName"></label>
                <input type="text" class="form-control" th:value="|First Name: ${firstName}|" id="inputFName" readonly aria-label="First Name ${firstName}">
            </div>

            <div class="form-group col-md-6">
                <label for="inputLName"></label>
                <input type="text" class="form-control" th:value="|Last Name: ${lastName}|" id="inputLName" readonly aria-label="Last Name ${lastName}">
            </div>
        </div>

        <div class="form-row">
            <div class="form-group col-md-6">
                <label for="inputSId"></label>
                <input type="text" class="form-control" th:value="|Student ID: ${student_id}|" id="inputSId" readonly aria-label="Student ID ${student_id}">
            </div>

            <div class="form-group col-md-2">
                <label for="readEmail"></label>
                <input class="form-control" type="text" value="Email:" id="readEmail" readonly aria-label="Email ${email}">
            </div>
            <div class="form-group col-md-4">
                <label for="inputEmail"></label>
                <input type="text" class="form-control" th:value="${email}" id="inputEmail" name="inputEmail" placeholder = "youremail@school.edu">
            </div>
        </div>

        <div class="row justify-content-center">

            <div class="form-group col-md-7">
                <label for="readBalance2"></label>
                <input class="form-control" type="text" style="text-align: center"
                       th:value="|Current Account Balance: ${account_balance}|" id="readBalance2" readonly aria-label="Current Account Balance ${account_balance}">
            </div>
        </div>


        <div class='row justify-content-md-center'>

            <div class="form-group col-md-3">
                <label for="readPayAmt"></label>
                <input class="form-control" type="text" value="Payment Amount with decimal" id="readPayAmt" readonly aria-label="Input for Payment Amount with decimal">
            </div>


            <div class="form-group col-md-3">
                <label for="inputAmt"></label>
                <input type="number" class="form-control" step="0.01" id="inputAmt" name="inputAmt" placeholder="50.00">
            </div>
        </div>

        <div class='row justify-content-md-center'>
            <button type="button" class="btn btn-dark btn-lg ml-5" id="startCheckoutButton">Pay Local</button>
            <button type="button" class="btn btn-dark btn-lg ml-3" id="startCheckoutInternational">Pay
                International
            </button>
        </div>
    </form>

    <br>
    <br>
</div>

<script>
    const FLYWIRE_PUBLIC_KEY = "[[${frontendKey}]]";
</script>

<!-- Flywire checkout script, local payment-->
<script type="module">
    window.addEventListener('DOMContentLoaded', () => {
        document.getElementById("startCheckoutButton").addEventListener("click", async (event) => {
            event.preventDefault();

            try {
                let input = document.getElementById("inputAmt");
                if (input.value) {
                    input.value = Math.round(parseFloat(input.value) * 100);
                }
                const inputAmt = input.value;
                console.log("InputAmt", inputAmt);

                let rawBalanceAmt = parseFloat(rawAccountBalance);
                if(inputAmt > (rawBalanceAmt * 100)) {
                    alert("Payment amount exceeds current account balance. Please enter a valid amount.");
                    return;
                }
                const emailValue = document.getElementById("inputEmail").value;
                // Call backend to get a Flywire session ID
                const response = await fetch("/api/flywire/session", {
                    method: "POST",
                    headers: { "Content-Type": "application/x-www-form-urlencoded" },
                    body: new URLSearchParams({ inputAmt: String(inputAmt), inputEmail: emailValue})
                });

                if (!response.ok) {
                    const text = await response.text();
                    console.error("Backend error:", response.status, text);
                    throw new Error("Failed to retrieve session ID");
                }

                const data = await response.json();
                const sessionId = data.id;
                console.log("Flywire session ID:", sessionId);

                // Initialize Flywire SDK
                console.log("FlywireSDK is:", window.FlywireSDK);
                const sdk = await window.FlywireSDK(FLYWIRE_PUBLIC_KEY);
                const elements = await sdk.elements();

                // Create the Flywire payment widget
                const checkout = await elements.create("payment", {
                    sessionId: sessionId,
                    displayMode: "full-screen"
                });

                // Success event handler
                checkout.onEvent("success", async (sessionResult) => {
                    const customSuccessMessage = "Your payment is now in progress. Flywire will send you further details and a tracking link by email or text.";
                    console.log("Raw Flywire success response:", JSON.stringify(sessionResult, null, 2));

                    try {
                        // Send sessionResult to backend
                        const res1 = await fetch('/api/flywire/payment-result', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(sessionResult)
                        });

                        if (!res1.ok) throw new Error(`payment-result failed with status ${res1.status}`);
                        const data1 = await res1.json();
                        const referenceId = data1.paymentReference;
                        console.log("Received paymentReference from backend:", referenceId);

                        // Send payment ID to /payments
                        const res2 = await fetch('/api/flywire/payments', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ payment_id: referenceId })
                        });

                        console.log("Fetch /payments response status:", res2.status);
                        if (!res2.ok) {
                            console.error("Failed to send payment ID to backend");
                            return;
                        }
                        const data = await res2.json(); // now contains { tracking_url: "..." }
                        const trackingUrl = encodeURIComponent(data.tracking_url);
                        console.log("Received tracking URL from backend:", trackingUrl);

                        // Show success message and redirect
                        alert(customSuccessMessage);
                        // window.location.href = "/success";
                        window.location.href = `/success?tracking_url=${trackingUrl}`;

                    } catch (err) {
                        console.error("Error in payment flow:", err);
                        alert("An error occurred while processing your payment.");
                    }
                });

                // Error event handler
                checkout.onEvent("error", (error) => {
                    const customErrorMessage = "Something went wrong. Please try again.";

                    // Send error to backend
                    fetch('/api/flywire/payment-result', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(error),
                    });

                    alert(customErrorMessage);
                });

                // Mount the checkout widget
                checkout.mount("my-container-id");
                document.getElementById("my-container-id").style.display = "inline";

            } catch (err) {
                console.error("Error loading Flywire:", err);
                alert("Unable to initiate payment.");
            }
        });
    });
</script>

<!-- Flywire checkout script, intl payment-->
<script type="module">
    window.addEventListener('DOMContentLoaded', () => {
        document.getElementById("startCheckoutInternational").addEventListener("click", async (event) => {
            event.preventDefault();

            try {
                let input = document.getElementById("inputAmt");
                if (input.value) {
                    input.value = Math.round(parseFloat(input.value) * 100);
                }
                const inputAmt = input.value;
                console.log("InputAmt", inputAmt);

                let rawBalanceAmt = parseFloat(rawAccountBalance);
                if(inputAmt > (rawBalanceAmt * 100)) {
                    alert("Payment amount exceeds current account balance. Please enter a valid amount.");
                    return;
                }
                const emailValue = document.getElementById("inputEmail").value;
                // Call backend to get a Flywire session ID
                const response = await fetch("/api/flywire/session", {
                    method: "POST",
                    headers: { "Content-Type": "application/x-www-form-urlencoded" },
                    body: new URLSearchParams({ inputAmt: String(inputAmt), inputEmail: emailValue})
                });

                if (!response.ok) {
                    const text = await response.text();
                    console.error("Backend error:", response.status, text);
                    throw new Error("Failed to retrieve session ID");
                }

                const data = await response.json();
                const sessionId = data.id;
                console.log("Flywire session ID:", sessionId);

                // Initialize Flywire SDK
                console.log("FlywireSDK is:", window.FlywireSDK);
                const sdk = await window.FlywireSDK(FLYWIRE_PUBLIC_KEY);
                const elements = await sdk.elements();

                // Create the Flywire payment widget
                const checkout = await elements.create("payment", {
                    sessionId: sessionId,
                    displayMode: "full-screen"
                });

                // Success event handler
                checkout.onEvent("success", async (sessionResult) => {
                    const customSuccessMessage = "Your payment is now in progress. Flywire will send you further details and a tracking link by email or text.";
                    console.log("Raw Flywire success response:", JSON.stringify(sessionResult, null, 2));

                    try {
                        // Send sessionResult to backend
                        const res1 = await fetch('/api/flywire/payment-result', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(sessionResult)
                        });

                        if (!res1.ok) throw new Error(`payment-result failed with status ${res1.status}`);
                        const data1 = await res1.json();
                        const referenceId = data1.paymentReference;
                        console.log("Received paymentReference from backend:", referenceId);

                        // Send payment ID to /payments
                        const res2 = await fetch('/api/flywire/payments', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ payment_id: referenceId })
                        });

                        console.log("Fetch /payments response status:", res2.status);
                        if (!res2.ok) {
                            console.error("Failed to send payment ID to backend");
                            return;
                        }
                        const data = await res2.json(); // now contains { tracking_url: "..." }
                        const trackingUrl = encodeURIComponent(data.tracking_url);
                        console.log("Received tracking URL from backend:", trackingUrl);

                        // Show success message and redirect
                        alert(customSuccessMessage);
                        // window.location.href = "/success";
                        window.location.href = `/success?tracking_url=${trackingUrl}`;

                    } catch (err) {
                        console.error("Error in payment flow:", err);
                        alert("An error occurred while processing your payment.");
                    }
                });

                // Error event handler
                checkout.onEvent("error", (error) => {
                    const customErrorMessage = "Something went wrong. Please try again.";

                    // Send error to backend
                    fetch('/api/flywire/payment-result', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(error),
                    });

                    alert(customErrorMessage);
                });

                // Mount the checkout widget
                checkout.mount("my-container-id");
                document.getElementById("my-container-id").style.display = "inline";

            } catch (err) {
                console.error("Error loading Flywire:", err);
                alert("Unable to initiate payment.");
            }
        });
    });
</script>
</body>

</html>